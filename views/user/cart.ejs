<!DOCTYPE HTML>
<html>
	<head>
	<title>CRUX | CART PAGE</title>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> 
	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Rokkitt:100,300,400,700" rel="stylesheet">
	
	<!-- Animate.css -->
	<link rel="stylesheet" href="/front/css/animate.css">
	<!-- Icomoon Icon Fonts-->
	<link rel="stylesheet" href="/front/css/icomoon.css">
	<!-- Ion Icon Fonts-->
	<link rel="stylesheet" href="/front/css/ionicons.min.css">
	<!-- Bootstrap  -->
	<link rel="stylesheet" href="/front/css/bootstrap.min.css">

	<!-- Magnific Popup -->
	<link rel="stylesheet" href="/front/css/magnific-popup.css">

	<!-- Flexslider  -->
	<link rel="stylesheet" href="/front/css/flexslider.css">

	<!-- Owl Carousel -->
	<link rel="stylesheet" href="/front/css/owl.carousel.min.css">
	<link rel="stylesheet" href="css/owl.theme.default.min.css">
	
	<!-- Date Picker -->
	<link rel="stylesheet" href="/front/css/bootstrap-datepicker.css">
	<!-- Flaticons  -->
	<link rel="stylesheet" href="/front/fonts/flaticon/font/flaticon.css">

	<!-- Theme style  -->
	<link rel="stylesheet" href="/front/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            .product-list {
			display: flex;
			overflow-x: auto;
			scroll-behavior: smooth;
			padding-bottom: 10px;
		}
		.scroll-btn {
			position: absolute;
			top: 50%;
			transform: translateY(-50%);
			background: white;
			border: none;
			cursor: pointer;
			font-size: 24px;
			padding: 10px;
			box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
			z-index: 10;
		}
		.left { left: -10px; }
		.right { right: -10px; }
        </style>
	</head>
	<body>
		
	
        <div id="page">
            <%- include('./userPartials/header') %>  
        
            <div class="colorlib-product">
                <div class="container">                
                    <div class="row row-pb-lg">
                        <div class="col-md-12">
                            <div class="product-name d-flex">
                                <div class="one-forth text-left px-4"><span>Product Details</span></div>
                                <div class="one-eight text-center"><span>Price</span></div>
                                <div class="one-eight text-center"><span>Quantity</span></div>
                                <div class="one-eight text-center"><span>Total</span></div>
                                <div class="one-eight text-center px-4"><span>Remove</span></div>
                            </div>
        
                            <% if (cartItems.length > 0) { %>
                                <% let subtotal = 0; %>
                                <% cartItems.forEach((item, index) => { %>
                                    <% let itemTotal = item.price * item.quantity; %>
                                    <% subtotal += itemTotal; %>
                                    <div class="product-cart d-flex" id="cart-item-<%= index %>">
                                        <div class="one-forth">
                                            <div class="product-img" style="background-image: url('<%= item.image %>');"></div>
                                            <div class="display-tc ps-5">
                                                <h6><%= item.name %></h6>
                                            </div>
                                        </div>
                                        <div class="one-eight text-center">
                                            <div class="display-tc">
                                                <span class="price">₹<%= item.price.toFixed(2) %></span>
                                            </div>
                                        </div>
                                        <div class="one-eight text-center">
                                            <div class="display-tc">
                                                <input type="number" class="form-control input-number text-center cart-quantity" 
                                                       data-index="<%= index %>" data-id="<%=item.id%>" 
                                                       value="<%= item.quantity %>" min="1" max="10" >
                                            </div>
                                        </div>
                                        <div class="one-eight text-center">
                                            <div class="display-tc">
                                                <span class="price total-price" id="total-<%= index %>">₹<%= itemTotal.toFixed(2) %></span>
                                            </div>
                                        </div>
                                        <div class="one-eight text-center">
                                            <div class="display-tc">
                                                <a href="#" class="closed remove-item" data-index="<%= index %>" onclick="removeProduct('<%=item.id%>')"></a>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            <% } else { %>
                                <p class="text-center">Your cart is empty.</p>
                            <% } %>
                        </div>
                    </div>
        
                    <div class="row row-pb-lg">
                        <div class="col-md-12">
                            <div class="total-wrap">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <form action="#">
                                            <div class="row form-group">
                                                <div class="col-sm-12">
                                                    <input type="text" class="form-control input-number" placeholder="Your Coupon Code...">
                                                </div>
                                                <div class="col-sm-3">
                                                    <input type="submit" value="Apply Coupon" class="btn btn-primary">
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-sm-5 text-center">
                                        <div class="total">
                                            <div class="sub">
                                                <p><span>Subtotal:</span> <span id="subtotal">₹<%= subtotal.toFixed(2) %></span></p>
                                                <p><span>Delivery:</span> <span>₹0.00</span></p>                                               
                                                <p><span>Discount:</span> <span id="discount">₹<%= discount.toFixed(2) %></span></p>
                                            </div>
                                            <div class="grand-total pb-2">                                               
                                                <p><span><strong>Total:</strong></span> <span id="grand-total">₹<%= grandTotal.toFixed(2) %></span></p>
                                            </div>
                                            <div class="">  
                                            <a href="/checkout"><button class="btn btn-md btn-primary">Proceed to Checkout</button></a>                                       
                                        </div>
                                        <div>
                                            <a href="/product-list"><button  class="btn btn-sm btn-secondary">Continue Shopping</button></a>
                                        </div>  
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
        
                        <div class="row">
                            <div class="col-sm-8 offset-sm-2 text-center colorlib-heading colorlib-heading-sm">
                                <h2>People also bought</h2>
                            </div>
                        </div>

                        <!-- Similar Products Section -->
					<div class="container">
						<!-- <h3 class="mb-5">Similar Products</h3> -->
						<%if(relatedProducts.length>0){%>
						<div class="position-relative">
							<!-- Scroll Buttons -->
							<button class="scroll-btn left" onclick="scrollProducts(-1)">&#10094;</button>
							<button class="scroll-btn right" onclick="scrollProducts(1)">&#10095;</button>

							<div class="product-list d-flex overflow-auto">
								<% relatedProducts.forEach(product => { %>
									<div class="card mx-2" style="min-width: 180px; max-width: 200px;">
										<div class="position-relative">
											<a href="/products/<%= product.slug%>"><img src="<%= product.images[0] %>" class="card-img-top" alt="<%= product.name %>"></a>
											<button class="btn btn-light position-absolute top-0 end-0 m-2 rounded-circle">
												<i class="fa fa-heart"></i>
											</button>
										</div>
										<div class="card-body p-2">
											<a class="nav-link" href="/products/<%= product.slug%>"><p class="card-title text-truncate mb-1"><%= product.name %></p></a>
											<p class="card-text mb-1">
												<strong>₹<%= product.finalPrice %></strong>
												<% if (product.discount) { %>
													<small class="text-muted ms-2"><del>₹<%= product.price %></del></small>
													<span class="text-success"> <%= product.discount %>% off</span>
												<% } %>
											</p>
										</div>
									</div>
								<% }) %>
								<%}else{%>
									<div class="col-md-12 text-center">No Products Available</div>
									<% } %>
							</div>
						</div>
					</div>
                       
                </div>
            </div>
        
            <%- include('./userPartials/footer') %>
        </div>
        
        

	<div class="gototop js-top">
		<a href="#" class="js-gotop"><i class="ion-ios-arrow-up"></i></a>
	</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
            document.querySelectorAll(".cart-quantity").forEach(input => {
        input.addEventListener("keydown", function (event) {
            event.preventDefault();  // Blocks manual input
        });
    });
        document.querySelectorAll('.cart-quantity').forEach(input => {
            input.addEventListener('change', function() {
                let index = this.dataset.index;
                let quantity = parseInt(this.value);    
                if (quantity < 1) quantity = 1;         
    
                let price = parseFloat(document.querySelector(`#cart-item-${index} .price`).innerText.replace('₹', ''));
                let total = quantity * price;
                document.getElementById(`total-${index}`).innerText = `₹${total.toFixed(2)}`;
    
                updateCartTotal();
            });
        });
    
        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                let index = this.dataset.index;
                document.getElementById(`cart-item-${index}`).remove();
                updateCartTotal();
            });
        });
    
                function updateCartTotal() {
            let subtotal = 0;
            document.querySelectorAll('.total-price').forEach(price => {
                subtotal += parseFloat(price.innerText.replace('₹', ''));
            });

            let discount = 0; // Ensure discount is 0 for now
            let grandTotal = subtotal - discount;

            document.getElementById('subtotal').innerText = `₹${subtotal.toFixed(2)}`;
            document.getElementById('discount').innerText = `₹${discount.toFixed(2)}`;
            document.getElementById('grand-total').innerText = `₹${grandTotal.toFixed(2)}`;
            
        }

        
        const removeProduct= async(itemId)=>{
            try{

            
            const response = await fetch('/remove-product/'+itemId, {
                method:"PATCH",
                headers: {
                    "Content-Type": "application/json"
        }
    });
        const result= await response.json();
        if(result.success){
            Swal.fire({
                icon: 'success',
                title: 'Product Removed',
                text: 'Product removed successfully',
                showConfirmButton: true                
            });
            updateCartTotal();
        }else{
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: result.message,
                showConfirmButton: true
        });
    }
    }catch(err){
        console.error(err);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Something Went Wrong',
            showConfirmButton: true
                });
            }
        }
    


        document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.cart-quantity').forEach(input => {
        input.addEventListener('change', async function () {
            let productId = this.getAttribute('data-id');
            let quantity = parseInt(this.value);

            // Prevent negative or zero quantity
            if (quantity < 1) {
                this.value = 1;
                quantity = 1;
            }

            try {
                const response = await fetch('/cart/update', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, quantity })
                });

                const result = await response.json();

                if (result.success) {                                       
                    updateCartTotal();
                } else if(result.adjustedQuantity !== undefined) {
                    document.querySelector(`[data-id="${productId}"]`).value = result.adjustedQuantity;
                    Swal.fire({
                        icon: "error",
                        title: "Not enough stock",
                        text: result.message+" "+result.adjustedQuantity,
                        showConfirmButton: true
                    });
                }
            } catch (err) {
                console.error(err);
                Swal.fire({
                    icon: "error",
                    title: "Something went wrong!",
                    text: "Please try again later.",
                    showConfirmButton: true
                });
            }
        });
    });

});

    </script>
	
	<!-- jQuery -->
	<script src="/front/js/jquery.min.js"></script>
   <!-- popper -->
   <script src="/front/js/popper.min.js"></script>
   <!-- bootstrap 4.1 -->
   <script src="/front/js/bootstrap.min.js"></script>
   <!-- jQuery easing -->
   <script src="/front/js/jquery.easing.1.3.js"></script>
	<!-- Waypoints -->
	<script src="js/jquery.waypoints.min.js"></script>
	<!-- Flexslider -->
	<script src="/front/js/jquery.flexslider-min.js"></script>
	<!-- Owl carousel -->
	<script src="/front/js/owl.carousel.min.js"></script>
	<!-- Magnific Popup -->
	<script src="/front/js/jquery.magnific-popup.min.js"></script>
	<script src="/front/js/magnific-popup-options.js"></script>
	<!-- Date Picker -->
	<script src="/front/js/bootstrap-datepicker.js"></script>
	<!-- Stellar Parallax -->
	<script src="/front/js/jquery.stellar.min.js"></script>
	<!-- Main -->
	<script src="/front/js/main.js"></script>

	</body>
</html>

