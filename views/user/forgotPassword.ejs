<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Crux Forgot Password</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="">
    <!-- Template CSS -->
    <link href="/assets/css/main.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <main>
        <section class="content-main mt-80 mb-80">
            <div class="card mx-auto card-login">
                <div class="card-body">
                    <img class="d-block mx-auto mb-3" src="/logo/logo-white.png" alt="CRUX">
                    <h4 class="card-title mb-4 text-center">Forgot Password</h4>
    
                    <% if (messages.success) { %>
                        <script> Swal.fire("Success", "<%= messages.success %>", "success"); </script>
                    <% } %>
    
                    <% if (messages.error) { %>
                        <script> Swal.fire("Error", "<%= messages.error %>", "error"); </script>
                    <% } %>
    
                    <!-- Forgot Password Button (Opens Email Confirmation Modal) -->
                    <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#emailModal">Forgot Password?</button>
                </div>
            </div>
        </section>
    
        <!-- Step 1: Confirm Email Modal -->
        <div class="modal fade" id="emailModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Enter Your Email</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="emailForm">
                            <label>Email Address</label>
                            <input type="email" name="email" class="form-control" id="email" required>
                            <button type="button" class="btn btn-primary w-100 mt-3" onclick="sendOTP()">Send OTP</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Step 2: OTP Verification Modal -->
        <div class="modal fade" id="otpModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Enter OTP</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="otpForm">
                            <input type="number" name="otp" class="form-control text-center" id="otp" placeholder="Enter 6-digit OTP" required>
                            <p id="timer" class="text-muted mt-2">Resend OTP in <span id="countdown">60</span> seconds</p>
                            <button type="button" class="btn btn-primary w-100 mt-3" onclick="verifyOTP()">Verify OTP</button>
                            <button type="button" id="resendOtp" class="btn btn-link mt-2" onclick="sendOTP()" disabled>Resend OTP</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Step 3: Reset Password Modal -->
        <div class="modal fade" id="resetModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Reset Password</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="resetForm">
                            <label>New Password</label>
                            <input type="password" class="form-control" id="password" required>
                            <label>Confirm Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                            <button type="button" class="btn btn-primary w-100 mt-3" onclick="resetPassword()">Reset Password</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
    <!-- Main Script -->
    <script src="/assets/js/main.js" type="text/javascript"></script>
    
    <script>
        let userEmail = "";
        let countdownTimer;
        let timeLeft = 60;
    
        function startCountdown() {
            timeLeft = 60;
            document.getElementById("countdown").textContent = timeLeft;
            document.getElementById("resendOtp").disabled = true;
    
            countdownTimer = setInterval(() => {
                timeLeft--;
                document.getElementById("countdown").textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    document.getElementById("resendOtp").disabled = false;
                }
            }, 1000);
        }
    
        function sendOTP() {
            userEmail = document.getElementById("email").value;
            fetch('/user/forgot-password', {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: userEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire("Success", "OTP sent to your email!", "success");
                    let emailModal = bootstrap.Modal.getInstance(document.getElementById("emailModal"));
                    emailModal.hide(); // âœ… Hide email modal using Bootstrap
                    let otpModal = new bootstrap.Modal(document.getElementById("otpModal"));
                    otpModal.show(); 
                    startCountdown();
                } else {
                    Swal.fire("Error", data.error, "error");
                }
            });
        }
    
        function verifyOTP() {
            let otp = document.getElementById("otp").value;
            fetch('/user/verify-otp', {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: userEmail, otp })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire("Success", "OTP Verified!", "success");
                    let otpModal = bootstrap.Modal.getInstance(document.getElementById("otpModal"));
            otpModal.hide();
            let resetModal = new bootstrap.Modal(document.getElementById("resetModal"));
            resetModal.show();
                } else {
                    Swal.fire("Error", data.error, "error");
                }
            });
        }
    
        function resetPassword() {
            let password = document.getElementById("password").value;
            let confirmPassword = document.getElementById("confirmPassword").value;
    
            if (password !== confirmPassword) {
                Swal.fire("Error", "Passwords do not match!", "error");
                return;
            }
    
            fetch('/user/reset-password', {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: userEmail, password, confirmPassword })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire("Success", "Password reset successfully!", "success")
                    .then(() => { window.location.href = "/user/login"; });
                } else {
                    Swal.fire("Error", data.error, "error");
                }
            });
        }
    </script>
    


</body>

</html>
